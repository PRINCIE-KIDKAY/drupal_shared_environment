name: Production Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "USER=$SERVER_USER"
          echo "HOST=$SERVER_HOST"
        
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'EOF'
          
          set -e

          # ---- Config ----
          PROJECT_DIR="$HOME/dev/projects/bluevine"
          REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          COMPOSE_FILE="docker-compose.prod.yml"

          # ---- Create dir ----
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"

          # ---- Git clone or pull ----
          if [ ! -d ".git" ]; then
              git clone "$REPO_URL" .
          else
              git remote set-url origin "$REPO_URL"
              git fetch origin
              git reset --hard origin/main
          fi

          # ---- Start nginx first (ACME required) ----
          docker compose -f "$COMPOSE_FILE" up -d nginx
          sleep 10

          # ---- Start rest of stack ----
          docker compose -f "$COMPOSE_FILE" up -d --build

          EOF

  certificates:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Create and validate certificates
        env:
          SERVER_HOST: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'EOF'
          set -euo pipefail

          PROJECT_DIR="$HOME/dev/projects/bluevine"
          COMPOSE_FILE="docker-compose.prod.yml"

          cd "$PROJECT_DIR"

          echo "===> Ensuring certbot dirs"
          mkdir -p ./nginx/certbot/www
          mkdir -p ./nginx/certbot/conf

          echo "===> Starting nginx (HTTP only mode)"
          docker compose -f "$COMPOSE_FILE" up -d nginx

          echo "===> Waiting for nginx..."
          sleep 5

          echo "===> Verifying nginx container state"
          docker compose -f "$COMPOSE_FILE" ps nginx | grep -q "Up" || {
            echo "FATAL: nginx not running"
            docker compose -f "$COMPOSE_FILE" logs nginx
            exit 1
          }

          echo "===> Verifying nginx config (HTTP only)"
          docker compose -f "$COMPOSE_FILE" exec -T nginx nginx -t || {
            echo "FATAL: nginx config invalid"
            exit 1
          }

          echo "===> Verifying ACME path write"
          docker compose -f "$COMPOSE_FILE" exec -T nginx sh -c "echo test > /var/www/certbot/test.txt"
          docker compose -f "$COMPOSE_FILE" exec -T nginx cat /var/www/certbot/test.txt | grep -q test || {
            echo "FATAL: ACME webroot not writable"
            exit 1
          }

          create_cert () {
            DOMAIN="$1"
            CERT_DIR="./nginx/certbot/conf/live/$DOMAIN"

            echo "===> Processing $DOMAIN"

            if [ -d "$CERT_DIR" ]; then
              echo "Certificate already exists for $DOMAIN"
              return 0
            fi

            echo "===> Requesting certificate for $DOMAIN"

            docker compose -f "$COMPOSE_FILE" run --rm certbot certonly \
              --webroot \
              -w /var/www/certbot \
              -d "$DOMAIN" \
              --agree-tos \
              --email certs@kmdev.co.za \
              --non-interactive \
              --rsa-key-size 4096

            echo "===> Verifying cert files for $DOMAIN"
            test -f "$CERT_DIR/fullchain.pem" || { echo "FATAL: fullchain.pem missing for $DOMAIN"; exit 1; }
            test -f "$CERT_DIR/privkey.pem"   || { echo "FATAL: privkey.pem missing for $DOMAIN"; exit 1; }

            echo "OK: $DOMAIN certificate valid"
          }

          # ---- Create certs ----
          create_cert "drupal.blue.kmdev.co.za"
          create_cert "pma.blue.kmdev.co.za"

          echo "===> Enabling SSL configs"
          mkdir -p ./nginx/conf.d/ssl-enabled

          # Copy single mixed SSL file (drupal + pma)
          cp ./nginx/conf.d/drupal.ssl.template.conf \
            ./nginx/conf.d/ssl-enabled/drupal.ssl.conf

          echo "===> Reloading nginx with SSL"
          docker compose -f "$COMPOSE_FILE" exec -T nginx nginx -t || {
            echo "FATAL: nginx SSL config invalid"
            exit 1
          }

          docker compose -f "$COMPOSE_FILE" exec -T nginx nginx -s reload

          echo "=== SSL bootstrap completed successfully ==="
          EOF
