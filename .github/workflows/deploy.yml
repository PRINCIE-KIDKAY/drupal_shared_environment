name: Production Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "USER=$SERVER_USER"
          echo "HOST=$SERVER_HOST"
        
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'EOF'
          
          set -e

          # ---- Config ----
          PROJECT_DIR="$HOME/dev/projects/bluevine"
          REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          COMPOSE_FILE="docker-compose.prod.yml"

          # ---- Create dir ----
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"

          # ---- Git clone or pull ----
          if [ ! -d ".git" ]; then
              git clone "$REPO_URL" .
          else
              git remote set-url origin "$REPO_URL"
              git fetch origin
              git reset --hard origin/main
          fi

          # ---- Start nginx first (ACME required) ----
          docker compose -f "$COMPOSE_FILE" up -d nginx
          sleep 10

          # ---- Start rest of stack ----
          docker compose -f "$COMPOSE_FILE" up -d --build

          EOF

  certificates:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Create and renew certificates
        env:
          SERVER_HOST: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          echo "USER=$SERVER_USER"
          echo "HOST=$SERVER_HOST"
          echo "Starting certificate creation/renewal process..."
        
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 "$SERVER_USER@$SERVER_HOST" << 'EOF'
          
          set -e

          # ---- Config ----
          PROJECT_DIR="$HOME/dev/projects/bluevine"
          COMPOSE_FILE="docker-compose.prod.yml"

          cd "$PROJECT_DIR"
          ls  

          # ---- Ensure certbot directories exist ----
          mkdir -p ./nginx/certbot/www
          mkdir -p ./nginx/certbot/conf

          # ---- Ensure nginx is running and healthy ----
          echo "Checking nginx status..."
          if ! docker compose -f "$COMPOSE_FILE" ps nginx | grep -q "Up"; then
            echo "Starting nginx..."
            docker compose -f "$COMPOSE_FILE" up -d nginx
            echo "Waiting for nginx to be ready..."
            sleep 5
          fi

          # ---- Verify nginx is running ----
          if ! docker compose -f "$COMPOSE_FILE" ps nginx | grep -q "Up"; then
            echo "ERROR: Nginx failed to start!"
            docker compose -f "$COMPOSE_FILE" logs nginx
            exit 1
          fi

          # ---- Verify nginx configuration ----
          echo "Verifying nginx configuration..."
          if ! docker compose -f "$COMPOSE_FILE" exec -T nginx nginx -t 2>&1; then
            echo "WARNING: Nginx configuration test failed, but continuing..."
            echo "This may be due to missing SSL certificates which will be created now"
          fi

          # ---- Test ACME challenge path is accessible ----
          echo "Testing ACME challenge path..."
          docker compose -f "$COMPOSE_FILE" exec -T nginx sh -c "echo 'test' > /var/www/certbot/test.txt && cat /var/www/certbot/test.txt" || {
            echo "WARNING: Could not write to certbot webroot"
          }

          # ---- Bootstrap certs ONLY (no renew in CI) ----
          create_cert() {
            local domain=$1
            local cert_dir="./nginx/certbot/conf/live/$domain"
            
            echo "Checking certificate for $domain..."
            if [ ! -d "$cert_dir" ]; then
              echo "Creating certificate for $domain..."
              
              # Run certbot with full output
              if docker compose -f "$COMPOSE_FILE" run --rm certbot certonly \
                --webroot \
                -w /var/www/certbot \
                -d "$domain" \
                --agree-tos \
                --email certs@kmdev.co.za \
                --non-interactive \
                --verbose 2>&1; then
                echo "Successfully created certificate for $domain"
                
                # Verify certificate was created
                if [ -d "$cert_dir" ] && [ -f "$cert_dir/fullchain.pem" ]; then
                  echo "Certificate verified: $cert_dir/fullchain.pem exists"
                else
                  echo "WARNING: Certificate directory exists but fullchain.pem not found"
                fi
              else
                local exit_code=$?
                echo "ERROR: Failed to create certificate for $domain (exit code: $exit_code)"
                echo "Checking if domain is reachable..."
                curl -I "http://$domain/.well-known/acme-challenge/test" || echo "Domain not reachable"
                return 1
              fi
            else
              echo "Certificate already exists for $domain"
            fi
          }

          # Create certificates
          create_cert "drupal.blue.kmdev.co.za" || exit 1
          create_cert "pma.blue.kmdev.co.za" || exit 1

          # ---- Reload nginx to pick up new certificates ----
          echo "Reloading nginx..."
          docker compose -f "$COMPOSE_FILE" exec -T nginx nginx -s reload || {
            echo "Nginx reload failed, restarting..."
            docker compose -f "$COMPOSE_FILE" restart nginx
          }

          echo "Certificate process completed successfully!"

          EOF
